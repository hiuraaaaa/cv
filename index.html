<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Converter TXT ➜ VCF (Multi-Negara + Otomatis)</title>

  <!-- Font Inter -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    /* ==== Tema Rynn (light pastel blue) ==== */
    :root{
      --bg:#eaf2ff;            /* latar biru lembut */
      --card:#ffffff;          /* kartu putih */
      --text:#0f172a;          /* slate-900 */
      --muted:#6b7280;         /* gray-500 */
      --accent:#3b82f6;        /* blue-500 */
      --accent-hover:#2563eb;  /* blue-600 */
      --border:#e5e7eb;        /* gray-200 */
      --shadow:0 8px 24px rgba(15,23,42,.06);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;background:var(--bg);color:var(--text);
      font:16px/1.55 "Inter",system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif
    }
    .container{max-width:1100px;margin:0 auto;padding:24px}
    h1{font-size:28px;margin:0 0 6px;font-weight:700}
    p.lead{color:var(--muted);margin:0 0 18px}

    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:900px){.grid{grid-template-columns:1.1fr .9fr}}

    .card{
      background:var(--card);border:1px solid var(--border);
      border-radius:var(--radius);box-shadow:var(--shadow)
    }
    .card .content{padding:20px}

    label{display:block;font-weight:600;margin:12px 0 6px}

    input[type="text"],input[type="number"],select,textarea{
      width:100%;padding:11px 14px;border:1px solid var(--border);border-radius:14px;background:#fff;color:var(--text);outline:none
    }
    textarea{min-height:160px;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    input:focus,textarea:focus,select:focus{
      border-color:var(--accent);box-shadow:0 0 0 4px rgba(59,130,246,.15)
    }

    .row{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:700px){.row.cols-2{grid-template-columns:1fr 1fr}.row.cols-3{grid-template-columns:repeat(3,1fr)}}
    .inline{display:flex;align-items:center;gap:8px}

    /* Buttons */
    .btn{display:inline-flex;align-items:center;gap:8px;border:none;border-radius:14px;padding:10px 16px;font-weight:700;cursor:pointer;transition:.15s}
    .btn:hover{filter:brightness(.98)}
    .btn.primary{background:var(--accent);color:#fff}
    .btn.primary:hover{background:var(--accent-hover)}
    .btn.secondary{
      background:#fff;color:var(--accent);border:1.5px solid var(--accent)
    }
    .btn.secondary:hover{background:#f1f5ff}

    .note{font-size:12px;color:#b45309;margin-top:4px}
    .muted{color:var(--muted)}
    .space{height:8px}

    /* Tabel preview */
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-top:1px solid var(--border);text-align:left}
    thead th{background:#f8faff}

    /* Tooltip (?) */
    .tipwrap{display:inline-flex;align-items:center;gap:6px}
    .tip{
      display:inline-flex;justify-content:center;align-items:center;width:18px;height:18px;
      border-radius:50%;background:#e8efff;color:#1e3a8a;font-weight:700;font-size:12px;cursor:pointer;user-select:none
    }
    .tip:hover{filter:brightness(.95)}
    .tooltip{
      position:fixed;z-index:9999;max-width:320px;background:#111;color:#fff;padding:10px 12px;border-radius:12px;
      font-size:13px;line-height:1.35;box-shadow:0 10px 30px rgba(0,0,0,.35);display:none
    }
    .tooltip a{color:#93c5fd}
  </style>

  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>Converter TXT ➜ VCF (Multi-Negara + Otomatis)</h1>
    <p class="lead">Tempel TXT berantakan pun bisa. Deteksi otomatis nomor dipisah koma/spasi/enter. Nomor lokal diubah ke internasional pakai kode negara.</p>
    <div id="totalCount" class="note" style="margin-bottom:10px">Total Nomor: 0</div>

    <div class="grid">
      <div class="card"><div class="content">
        <div class="row cols-2">
          <div>
            <label class="tipwrap">Upload file (.txt / .csv)
              <span class="tip" data-tip="Kamu bisa upload TXT/CSV. Isinya boleh acak, penting ada nomor telepon.">?</span>
            </label>
            <input id="file" type="file" accept=".txt,.csv" />
          </div>
          <div>
            <label class="tipwrap">Atau tempel data
              <span class="tip" data-tip="Contoh:\n6282828382,62728282\n6373828282 627382832\n6282838382 , 6382939393\n6272727272\n6272828283\n+\n0\n• Tanda '+' atau '0' sendirian akan diabaikan.">?</span>
            </label>
            <textarea id="raw" placeholder="Contoh:
6282828382,62728282
6373828282, 627382832
6282838382 , 6382939393
6272727272
6272828283
+
0"></textarea>
          </div>
        </div>

        <div class="row cols-3">
          <div>
            <label class="tipwrap">Mode gabung per baris
              <span class="tip" data-tip="ON: setiap baris jadi 1 kontak (boleh multi nomor per kontak).\nOFF: setiap nomor jadi 1 kontak.">?</span>
            </label>
            <div class="inline">
              <input id="mergeLine" type="checkbox" />
              <span class="muted">ON = 1 baris ➜ 1 kontak (multi nomor)</span>
            </div>
          </div>
          <div>
            <label class="tipwrap">Kontak per file (gabung)
              <span class="tip" data-tip="Isi 20 ➜ tiap file .vcf berisi 20 kontak. Hasil diunduh ZIP. Isi 0 ➜ semua kontak dalam 1 file.">?</span>
            </label>
            <input id="chunk" type="number" min="0" value="0" placeholder="0 = semua dalam 1 file" />
          </div>
          <div>
            <label class="tipwrap">Satu kontak = satu file (ZIP)
              <span class="tip" data-tip="Jika dicentang, setiap kontak dibuat file .vcf terpisah.">?</span>
            </label>
            <div class="inline"><input id="perFile" type="checkbox" /><span class="muted">Setiap kontak jadi 1 .vcf</span></div>
          </div>
        </div>

        <div class="row cols-3">
          <div>
            <label class="tipwrap">Kode negara default
              <span class="tip" data-tip="Dipakai untuk mengubah nomor lokal (diawali 0 / tanpa +) ke format internasional. Nomor yang sudah pakai + tidak diubah.">?</span>
            </label>
            <select id="countryDefault">
              <option value="+62" selected>Indonesia (+62)</option>
              <option value="+852">Hong Kong (+852)</option>
              <option value="+49">Jerman (+49)</option>
              <option value="+60">Malaysia (+60)</option>
              <option value="+63">Filipina (+63)</option>
              <option value="+65">Singapura (+65)</option>
              <option value="+1">AS (+1)</option>
              <option value="custom">Kustom…</option>
            </select>
            <input id="countryCustom" type="text" placeholder="contoh: +852" style="margin-top:6px; display:none" />
          </div>
          <div>
            <label>Nama file dasar</label>
            <input id="base" type="text" value="contacts" />
          </div>
          <div>
            <label>Nomor file mulai</label>
            <input id="start" type="number" min="0" value="1" />
          </div>
        </div>

        <div class="space"></div>
        <div class="inline" style="gap:10px">
          <button id="convert" class="btn primary">Konversi & Unduh</button>
          <button id="clear" class="btn secondary">Bersihkan</button>
        </div>
      </div></div>

      <div class="card"><div class="content">
        <h3 style="margin:0 0 10px">Pratinjau (maks 5 baris)</h3>
        <div style="overflow:auto;border:1px solid var(--border);border-radius:14px">
          <table id="previewTbl">
            <thead><tr id="previewHead"></tr></thead>
            <tbody id="previewBody"><tr><td class="muted" style="padding:16px">Belum ada data</td></tr></tbody>
          </table>
        </div>
        <h3 style="margin:18px 0 8px">Catatan</h3>
        <ul class="muted" style="margin:0 0 4px 18px">
          <li>Simbol tunggal seperti <code>+</code> atau <code>0</code> di baris sendiri akan diabaikan otomatis.</li>
          <li>Nomor dengan <code>+</code> dianggap sudah internasional dan tidak diubah.</li>
          <li>Nomor lokal diawali 0 → diubah memakai kode negara default.</li>
        </ul>
      </div></div>
    </div>
  </div>

  <!-- Tooltip -->
  <div id="tooltip" class="tooltip" role="tooltip" aria-hidden="true"></div>

<script>
  const el = (id)=>document.getElementById(id);
  const fileEl = el('file');
  const rawEl = el('raw');
  const countryDefaultEl = el('countryDefault');
  const countryCustomEl = el('countryCustom');
  const mergeLineEl = el('mergeLine');
  const perFileEl = el('perFile');
  const chunkEl = el('chunk');
  const baseEl = el('base');
  const startEl = el('start');
  const convertBtn = el('convert');
  const clearBtn = el('clear');
  const headRow = el('previewHead');
  const body = el('previewBody');
  const totalCountEl = el('totalCount');

  // Tooltip
  const tooltip = el('tooltip');
  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('.tip');
    if(btn){ showTip(btn, btn.getAttribute('data-tip') || ''); }
    else { hideTip(); }
  });
  function showTip(btn, text){
    tooltip.textContent = text; tooltip.style.display = 'block';
    tooltip.setAttribute('aria-hidden','false');
    // posisi
    const rect = btn.getBoundingClientRect(), pad = 8;
    // temporer render agar dapat ukuran
    tooltip.style.left = '0px'; tooltip.style.top = '-9999px';
    requestAnimationFrame(()=>{
      const topAbove = rect.top - tooltip.offsetHeight - pad;
      const topBelow = rect.bottom + pad;
      const left = Math.min(window.innerWidth - tooltip.offsetWidth - 10, Math.max(10, rect.left));
      tooltip.style.left = left + 'px';
      tooltip.style.top = (topAbove > 0 ? topAbove : topBelow) + 'px';
    });
  }
  function hideTip(){
    tooltip.style.display = 'none';
    tooltip.setAttribute('aria-hidden','true');
  }

  // File load
  fileEl.addEventListener('change', (e)=>{
    const f = e.target.files && e.target.files[0];
    if(!f) return;
    const r = new FileReader();
    r.onload = (ev)=>{ rawEl.value = String(ev.target.result||''); renderPreview(); updateTotal(); };
    r.readAsText(f);
  });

  [rawEl, mergeLineEl, countryDefaultEl, countryCustomEl].forEach(elm=>{
    elm.addEventListener('input', ()=>{ renderPreview(); updateTotal(); });
    elm.addEventListener('change', ()=>{ renderPreview(); updateTotal(); });
  });

  countryDefaultEl.addEventListener('change', ()=>{
    countryCustomEl.style.display = countryDefaultEl.value === 'custom' ? 'block' : 'none';
  });

  function pickDefaultDial(){
    if(countryDefaultEl.value === 'custom'){
      const v = (countryCustomEl.value||'').trim();
      return /^\+\d+$/.test(v) ? v : '+62';
    }
    return countryDefaultEl.value;
  }

  function extractNumbers(){
    const lines = (rawEl.value||'').replace(/\r\n?/g,'\n').split('\n');
    const result = [];
    for(const line of lines){
      const matches = (line.match(/\+?\d{5,}/g) || []).map(s=>s.trim());
      const cleaned = matches.filter(s=> s !== '+' && s !== '0');
      result.push(cleaned);
    }
    return result;
  }

  function countNumbers(){
    const perLine = extractNumbers();
    return perLine.reduce((acc, arr)=> acc + arr.length, 0);
  }

  function renderPreview(){
    const perLine = extractNumbers();
    headRow.innerHTML = '';
    body.innerHTML = '';
    const th1 = document.createElement('th'); th1.textContent = 'Baris'; headRow.appendChild(th1);
    const th2 = document.createElement('th'); th2.textContent = mergeLineEl.checked ? 'Nomor (gabung per baris)' : 'Nomor'; headRow.appendChild(th2);

    let shown = 0;
    for(let i=0;i<perLine.length && shown<5;i++){
      const nums = perLine[i];
      if(nums.length===0) continue;
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${i+1}</td><td>${mergeLineEl.checked ? nums.join(', ') : nums.join(' | ')}</td>`;
      body.appendChild(tr);
      shown++;
    }
    if(shown===0){
      body.innerHTML = '<tr><td class="muted" colspan="2" style="padding:16px">Belum ada nomor terdeteksi</td></tr>';
    }
  }

  function escapeVCF(s){
    return String(s).replace(/\\/g,'\\\\').replace(/\n/g,'\\n').replace(/,/g,'\\,').replace(/;/g,'\\;');
  }

  function normalizePhone(phone){
    if(!phone) return '';
    const dial = pickDefaultDial();
    const digits = String(phone).replace(/[^0-9+]/g,'');
    if(/^\+\d+$/.test(digits)) return digits;
    if(/^0\d+$/.test(digits)) return dial + digits.slice(1);
    if(/^\d+$/.test(digits))  return dial + digits;
    return digits;
  }

  function makeVCardMulti(name, phones){
    const nm = (name||'Tanpa Nama').toString().trim();
    const lines = [
      'BEGIN:VCARD',
      'VERSION:3.0',
      'N:;' + escapeVCF(nm) + ';;;',
      'FN:' + escapeVCF(nm)
    ];
    phones.forEach(ph=>{ if(ph){ lines.push('TEL;TYPE=CELL:' + ph); } });
    lines.push('END:VCARD','');
    return lines.join('\n');
  }

  async function convert(){
    const perLine = extractNumbers();
    const base = (baseEl.value||'contacts').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'') || 'contacts';
    const start = Number(startEl.value||1);
    const perFileCount = Number(chunkEl.value||0);

    const vcards = [];
    if(mergeLineEl.checked){
      let idx = 1;
      for(const nums of perLine){
        if(nums.length===0) continue;
        vcards.push(makeVCardMulti('Kontak ' + String(idx).padStart(3,'0'), nums.map(normalizePhone)));
        idx++;
      }
    } else {
      let idx = 1;
      for(const nums of perLine){
        for(const n of nums){
          vcards.push(makeVCardMulti('Kontak ' + String(idx).padStart(3,'0'), [normalizePhone(n)]));
          idx++;
        }
      }
    }

    if(vcards.length===0){ alert('Tidak ada nomor valid yang terdeteksi.'); return; }

    if(perFileEl.checked){
      const zip = new JSZip();
      vcards.forEach((vcf,i)=>{
        const num = String(start + i).padStart(3,'0');
        zip.file(`${base}-${num}.vcf`, vcf);
      });
      const blob = await zip.generateAsync({type:'blob'});
      downloadBlob(blob, `${base}-perkontak.zip`);
      return;
    }

    if(perFileCount > 0){
      const zip = new JSZip();
      let fileIdx = 0;
      for(let i=0; i<vcards.length; i+=perFileCount){
        const part = vcards.slice(i, i+perFileCount).join('\n');
        const num = String(start + fileIdx).padStart(3,'0');
        zip.file(`${base}-${num}.vcf`, part);
        fileIdx++;
      }
      const blob = await zip.generateAsync({type:'blob'});
      downloadBlob(blob, `${base}-split.zip`);
      return;
    }

    const blob = new Blob([vcards.join('\n')], {type:'text/vcard;charset=utf-8'});
    downloadBlob(blob, `${base}.vcf`);
  }

  function updateTotal(){ totalCountEl.textContent = `Total Nomor: ${countNumbers()}`; }

  function downloadBlob(blob, filename){
    const a = document.createElement('a');
    const url = URL.createObjectURL(blob);
    a.href = url; a.download = filename; document.body.appendChild(a); a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
  }

  document.getElementById('convert').addEventListener('click', convert);
  document.getElementById('clear').addEventListener('click', ()=>{ rawEl.value=''; renderPreview(); updateTotal(); });

  // init
  renderPreview();
  updateTotal();
</script>
</body>
</html>
