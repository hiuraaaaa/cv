<!doctype html>

<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Converter TXT ➜ VCF (Multi-Negara)</title>
  <style>
    :root{--bg:#f7f7fb;--card:#fff;--text:#1f2937;--muted:#6b7280;--accent:#2563eb;--border:#e5e7eb}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    .container{max-width:1100px;margin:0 auto;padding:24px}
    h1{font-size:28px;margin:0 0 6px} p.lead{color:var(--muted);margin:0 0 20px}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:900px){.grid{grid-template-columns:1.1fr .9fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .card .content{padding:20px}
    label{display:block;font-weight:600;margin:12px 0 6px}
    input[type="text"],input[type="number"],select,textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff}
    textarea{min-height:140px;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .row{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:700px){.row.cols-2{grid-template-columns:1fr 1fr}.row.cols-3{grid-template-columns:repeat(3,1fr)}}
    .inline{display:flex;align-items:center;gap:8px}
    .btn{display:inline-flex;align-items:center;gap:8px;background:var(--accent);color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
    .btn.secondary{background:#e5e7eb;color:#111}
    .note{font-size:12px;color:#b45309;margin-top:4px}
    .muted{color:var(--muted)}
    .space{height:8px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>Converter TXT ➜ VCF (Multi-Negara)</h1>
    <p class="lead">Dukungan kode negara: **Hong Kong (+852), Jerman (+49), Malaysia (+60)**, dan lainnya. Bisa satu file, per-kontak (ZIP), atau gabung N kontak per file (ZIP).</p>
    <div id="totalCount" class="note" style="margin-bottom:10px">Total Nomor: 0</div><div class="grid">
  <div class="card"><div class="content">
    <div class="row cols-2">
      <div>
        <label>Upload file (.txt / .csv)</label>
        <input id="file" type="file" accept=".txt,.csv" />
      </div>
      <div>
        <label>Atau tempel data</label>
        <textarea id="raw" placeholder="Nama,Nomor,Negara(optional)\nAndi,08123456789,ID\nBudi,628111223344,MY"></textarea>
      </div>
    </div>

    <div class="row cols-3">
      <div>
        <label>Delimiter</label>
        <select id="delimiter">
          <option value="," selected>Koma (,)</option>
          <option value=";">Titik koma (;)</option>
          <option value="\t">Tab</option>
          <option value="|">Pipa (|)</option>
          <option value=" ">Spasi</option>
        </select>
        <div id="autodelim" class="note"></div>
      </div>
      <div class="inline" style="margin-top:34px">
        <input id="hasHeader" type="checkbox" checked />
        <label for="hasHeader" style="margin:0;font-weight:500">Baris pertama adalah header</label>
      </div>
      <div>
        <label>Lewati N baris (mulai)</label>
        <input id="skip" type="number" min="0" value="0" />
      </div>
    </div>

    <div class="row cols-3">
      <div>
        <label>Kolom Nama</label>
        <select id="nameCol"></select>
      </div>
      <div>
        <label>Kolom Nomor</label>
        <select id="phoneCol"></select>
      </div>
      <div>
        <label>Kolom Kode Negara (opsional)</label>
        <select id="countryCol"></select>
        <div class="note">Boleh berisi <code>+NN</code>, ISO-2 (mis. <code>HK</code>, <code>DE</code>, <code>MY</code>), atau nama negara ("Hong Kong", "Germany", "Malaysia").</div>
      </div>
    </div>

    <div class="row cols-3">
      <div>
        <label>Kode negara default</label>
        <select id="countryDefault">
          <option value="+62">Indonesia (+62)</option>
          <option value="+852">Hong Kong (+852)</option>
          <option value="+49">Jerman / Germany (+49)</option>
          <option value="+60">Malaysia (+60)</option>
          <option value="+65">Singapura (+65)</option>
          <option value="+66">Thailand (+66)</option>
          <option value="+63">Filipina (+63)</option>
          <option value="+84">Vietnam (+84)</option>
          <option value="+91">India (+91)</option>
          <option value="+1">Amerika Serikat (+1)</option>
          <option value="custom">Kustom…</option>
        </select>
        <input id="countryCustom" type="text" placeholder="contoh: +852" style="margin-top:6px; display:none" />
        <div class="note">Dipakai bila kolom kode negara kosong dan nomor tidak diawali <code>+</code>.</div>
      </div>
      <div>
        <label>Satu kontak = satu file (ZIP)</label>
        <div class="inline">
          <input id="perFile" type="checkbox" />
          <span class="muted">Aktifkan jika ingin setiap kontak jadi 1 .vcf</span>
        </div>
      </div>
      <div>
        <label>Kontak per file (gabung)</label>
        <input id="chunk" type="number" min="0" value="0" placeholder="0 = nonaktif (semua dalam 1 file)" />
      </div>
    </div>

    <div class="row cols-3">
      <div>
        <label>Nama file dasar</label>
        <input id="base" type="text" value="contacts" placeholder="mis. pelanggan" />
      </div>
      <div>
        <label>Nomor file mulai</label>
        <input id="start" type="number" min="0" value="1" />
      </div>
      <div></div>
    </div>

    <div class="space"></div>
    <div class="inline" style="gap:10px">
      <button id="convert" class="btn">Konversi & Unduh</button>
      <button id="clear" class="btn secondary">Bersihkan</button>
    </div>
  </div></div>

  <div class="card"><div class="content">
    <h3 style="margin:0 0 10px">Pratinjau (maks 5 baris)</h3>
    <div style="overflow:auto;border:1px solid var(--border);border-radius:12px">
      <table id="previewTbl">
        <thead><tr id="previewHead"></tr></thead>
        <tbody id="previewBody"><tr><td class="muted" style="padding:16px">Belum ada data</td></tr></tbody>
      </table>
    </div>
    <h3 style="margin:18px 0 8px">Tips multi-negara</h3>
    <ul class="muted">
      <li>Jika nomor sudah diawali <code>+</code>, alat <b>tidak</b> mengubahnya.</li>
      <li>Jika nomor domestik diawali <code>0</code>, akan diubah ke format internasional memakai kode negara dari kolom/ default.</li>
      <li>Kolom Kode Negara bisa berupa <code>HK</code>, <code>DE</code>, <code>MY</code>, <code>+60</code>, atau nama negara.</li>
    </ul>
  </div></div>
</div>

  </div><script>
  const el = (id)=>document.getElementById(id);
  const fileEl = el('file');
  const rawEl = el('raw');
  const delimEl = el('delimiter');
  const autoDelimEl = el('autodelim');
  const hasHeaderEl = el('hasHeader');
  const skipEl = el('skip');
  const nameColEl = el('nameCol');
  const phoneColEl = el('phoneCol');
  const countryColEl = el('countryCol');
  const countryDefaultEl = el('countryDefault');
  const countryCustomEl = el('countryCustom');
  const perFileEl = el('perFile');
  const chunkEl = el('chunk');
  const baseEl = el('base');
  const startEl = el('start');
  const convertBtn = el('convert');
  const clearBtn = el('clear');

  const headRow = el('previewHead');
  const body = el('previewBody');
  const totalCountEl = el('totalCount');

  const COUNTRY_MAP = {
    // common
    'ID': '+62', 'INDONESIA': '+62',
    'HK': '+852','HONG KONG': '+852','HONGKONG': '+852',
    'DE': '+49','GERMANY': '+49','DEUTSCHLAND': '+49','JERMAN': '+49',
    'MY': '+60','MALAYSIA': '+60',
    'SG': '+65','SINGAPORE': '+65','SINGAPURA': '+65',
    'TH': '+66','THAILAND': '+66',
    'PH': '+63','PHILIPPINES': '+63','FILIPINA': '+63',
    'VN': '+84','VIETNAM': '+84',
    'IN': '+91','INDIA': '+91',
    'US': '+1','USA': '+1','UNITED STATES': '+1','AMERIKA SERIKAT': '+1',
    'GB': '+44','UK': '+44','UNITED KINGDOM': '+44','BRITAIN': '+44','INGGRIS': '+44'
  };

  let rows = [];

  fileEl.addEventListener('change', (e)=>{
    const f = e.target.files && e.target.files[0];
    if(!f) return;
    const r = new FileReader();
    r.onload = (ev)=>{ rawEl.value = String(ev.target.result||''); refresh(); };
    r.readAsText(f);
  });

  [rawEl, delimEl, hasHeaderEl, skipEl, countryDefaultEl].forEach(elm=>{
    elm.addEventListener('input', refresh);
    elm.addEventListener('change', refresh);
  });
  countryDefaultEl.addEventListener('change', ()=>{
    countryCustomEl.style.display = countryDefaultEl.value === 'custom' ? 'block' : 'none';
  });

  function refresh(){
    const text = rawEl.value || '';
    const dGuess = guessDelimiter(text);
    autoDelimEl && (autoDelimEl.textContent = dGuess && dGuess !== delimEl.value ? `Sepertinya delimiter Anda "${prettyDelim(dGuess)}".` : '');

    rows = parseText(text, delimEl.value);

    const cols = (rows[0]||[]).length;
    populateSelect(nameColEl, cols);
    populateSelect(phoneColEl, cols);
    populateSelect(countryColEl, cols, true);

    renderPreview();
    updateTotal();
  }

  function populateSelect(sel, cols, allowNone){
    const current = sel.value;
    sel.innerHTML = '';
    if(allowNone){
      const optNone = document.createElement('option');
      optNone.value = '-1'; optNone.textContent = '— Tidak ada —'; sel.appendChild(optNone);
    }
    for(let i=0;i<cols;i++){
      const opt = document.createElement('option');
      opt.value = String(i);
      opt.textContent = 'Kolom ' + (i+1);
      sel.appendChild(opt);
    }
    if(current && Number(current) < cols) sel.value = current; else sel.value = allowNone? '-1' : (sel===nameColEl? '0' : cols>1? '1':'0');
  }

  function dataRows(){
    let r = rows.slice();
    if(hasHeaderEl.checked && r.length) r = r.slice(1);
    const skip = Number(skipEl.value||0);
    if(skip>0) r = r.slice(skip);
    return r.filter(row => row.some(c => String(c).trim()!==''));
  }

  function renderPreview(){
    const hdr = rows[0]||[];
    headRow.innerHTML = '';
    if(hdr.length===0){ body.innerHTML = '<tr><td class="muted" style="padding:16px">Belum ada data</td></tr>'; return; }

    hdr.forEach((_,i)=>{
      const th = document.createElement('th');
      th.textContent = 'Kolom ' + (i+1);
      headRow.appendChild(th);
    });

    const d = dataRows().slice(0,5);
    body.innerHTML = '';
    if(d.length===0){ body.innerHTML = '<tr><td class="muted" style="padding:16px">Tidak ada data</td></tr>'; return; }
    d.forEach(r=>{
      const tr = document.createElement('tr');
      r.forEach(c=>{
        const td=document.createElement('td'); td.textContent = String(c); tr.appendChild(td);
      });
      body.appendChild(tr);
    });
  }

  function updateTotal(){ totalCountEl.textContent = `Total Nomor: ${dataRows().length}`; }

  function parseText(text, delim){
    if(!text) return [];
    const lines = text.replace(/\r\n?/g,'\n').split('\n');
    const d = delim === '\\t' ? '\t' : delim;
    return lines.map(line=> line.split(d));
  }

  function prettyDelim(d){ return d==='\t'?'Tab':d===','?'Koma':d===';'?'Titik koma':d==='|'?'Pipa':d===' ' ? 'Spasi' : d; }

  function escapeVCF(s){ return String(s).replace(/\\/g,'\\\\').replace(/\n/g,'\\n').replace(/,/g,'\\,').replace(/;/g,'\\;'); }

  function pickDefaultDial(){
    if(countryDefaultEl.value === 'custom'){
      const v = (countryCustomEl.value||'').trim();
      return /^\+\d+$/.test(v) ? v : '+62';
    }
    return countryDefaultEl.value;
  }

  function resolveDialFromText(txt){
    if(!txt) return null;
    const t = String(txt).trim();
    if(/^\+\d+$/.test(t)) return t; // already +code
    const key = t.toUpperCase();
    if(COUNTRY_MAP[key]) return COUNTRY_MAP[key];
    // try stripping spaces & punctuation
    const norm = key.replace(/[^A-Z0-9]/g,'');
    if(COUNTRY_MAP[norm]) return COUNTRY_MAP[norm];
    return null;
  }

  function normalizePhoneByCountry(rawPhone, row){
    if(!rawPhone) return '';
    const phone = String(rawPhone).replace(/[^0-9+]/g,'');
    if(/^\+\d+$/.test(phone)) return phone; // already international

    // derive dial code: priority = per-row col > default
    let dial = null;
    const colIdx = Number(countryColEl.value||-1);
    if(colIdx >= 0){ dial = resolveDialFromText(row[colIdx]); }
    if(!dial) dial = pickDefaultDial();

    // if number starts with 0 (trunk), drop the leading 0 except for countries without trunk
    // Heuristic: for HK (+852) there is no trunk 0, for others commonly there is.
    const hasTrunk = dial !== '+852';
    if(hasTrunk && /^0\d+$/.test(phone)){
      return dial + phone.slice(1);
    }
    if(/^\d+$/.test(phone)) return dial + phone; // bare digits
    return phone;
  }

  function makeVCard(name, phone){
    const nm = (name||'Tanpa Nama').toString().trim();
    return [
      'BEGIN:VCARD',
      'VERSION:3.0',
      'N:;' + escapeVCF(nm) + ';;;',
      'FN:' + escapeVCF(nm),
      phone ? 'TEL;TYPE=CELL:' + phone : null,
      'END:VCARD',''
    ].filter(Boolean).join('\n');
  }

  async function convert(){
    const dr = dataRows();
    if(!dr.length){ alert('Tidak ada data untuk dikonversi.'); return; }

    const nameIdx = Number(nameColEl.value||0);
    const phoneIdx = Number(phoneColEl.value||1);

    const vcards = dr.map(row => {
      const normalized = normalizePhoneByCountry(row[phoneIdx], row);
      return makeVCard(row[nameIdx], normalized);
    });

    const base = (baseEl.value||'contacts').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'') || 'contacts';
    const start = Number(startEl.value||1);
    const chunk = Number(chunkEl.value||0);

    if(perFileEl.checked){
      const zip = new JSZip();
      dr.forEach((row, i) => {
        const nmRaw = String(row[nameIdx]||'kontak').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
        const num = String(start + i).padStart(3,'0');
        const fname = `${base}-${num}-${nmRaw||'kontak'}.vcf`;
        zip.file(fname, vcards[i]);
      });
      const blob = await zip.generateAsync({type:'blob'});
      downloadBlob(blob, `${base}-vcards-per-kontak.zip`);
      return;
    }

    if(chunk > 0){
      const zip = new JSZip();
      let fileIdx = 0;
      for(let i=0; i<vcards.length; i += chunk){
        const part = vcards.slice(i, i+chunk).join('\n');
        const num = String(start + fileIdx).padStart(3, '0');
        const fname = `${base}-${num}.vcf`;
        zip.file(fname, part);
        fileIdx++;
      }
      const blob = await zip.generateAsync({type:'blob'});
      downloadBlob(blob, `${base}-vcards-chunked.zip`);
      return;
    }

    const blob = new Blob([vcards.join('\n')], {type:'text/vcard;charset=utf-8'});
    downloadBlob(blob, `${base}.vcf`);
  }

  function downloadBlob(blob, filename){
    const a = document.createElement('a');
    const url = URL.createObjectURL(blob);
    a.href = url; a.download = filename; document.body.appendChild(a); a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
  }

  // init
  const convertBtn = document.getElementById('convert');
  const clearBtn = document.getElementById('clear');
  convertBtn.addEventListener('click', convert);
  clearBtn.addEventListener('click', ()=>{ rawEl.value=''; rows=[]; renderPreview(); updateTotal(); });

  function guessDelimiter(text){
    if(!text) return ',';
    const sample = text.split(/\r?\n/).slice(0,5);
    const arr = [',',';','\t','|',' '].map(d=>({d, n: sample.map(l=> l.split(d).length).reduce((a,b)=>a+b,0)}));
    arr.sort((a,b)=>b.n-a.n);
    return arr[0].d;
  }

  refresh();
</script></body>
</html>
